name: Workload ingest (every 15 min)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  ingest:
    runs-on: ubuntu-latest

    env:
      # ---- GCP / BigQuery (read by your R script) ----
      GCP_PROJECT: ${{ secrets.GCP_PROJECT }}          # e.g. sac-vald-hub
      BQ_DATASET:  ${{ vars.BQ_DATASET || 'analytics' }}
      BQ_LOCATION: ${{ vars.BQ_LOCATION || 'US' }}
      BQ_TABLE:    ${{ vars.BQ_TABLE    || 'workload_daily' }}
      BQ_WRITE_MODE: ${{ vars.BQ_WRITE_MODE || 'MERGE' }}

      # ---- Azure / OneDrive (Graph app creds) ----
      AZURE_TENANT_ID:     ${{ secrets.AZURE_TENANT_ID }}
      AZURE_CLIENT_ID:     ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}

      # File location in SharePoint / OneDrive for Business
      SHAREPOINT_SITE_URL: ${{ vars.SHAREPOINT_SITE_URL }}         # e.g. https://contoso.sharepoint.com/sites/DataTeam
      ONEDRIVE_ITEM_PATH:  ${{ vars.ONEDRIVE_ITEM_PATH }}          # e.g. Shared Documents/GPS/CSV_Clean/Clean_Activities_GPS.csv
      # Optional debug: LOCAL_FILE_PATH: path/to/Clean_Activities_GPS.csv

    steps:
      - uses: actions/checkout@v4

      # === SAME GOOGLE AUTH METHOD AS YOUR EXISTING JOBS ===
      - name: Auth to Google Cloud (service account JSON)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}  # EXACTLY one input; must be a valid SA JSON
          create_credentials_file: true
          export_environment_variables: true

      - name: Setup gcloud (so R can run `gcloud auth print-access-token`)
        uses: google-github-actions/setup-gcloud@v2

      # R + cached dependencies (pak-backed)
      - name: Setup R
        uses: r-lib/actions/setup-r@v2

      - name: Install R deps (cached)
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          use-public-rspm: true
          cache-version: 1
          extra-packages: |
            any::bigrquery
            any::DBI
            any::dplyr
            any::tidyr
            any::readr
            any::stringr
            any::purrr
            any::tibble
            any::data.table
            any::hms
            any::lubridate
            any::httr
            any::jsonlite
            any::curl
            any::gargle
            any::glue
            any::slider
            any::janitor

      - name: System libs
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev

      - name: Run workload ingest
        run: Rscript workload_ingest.R
