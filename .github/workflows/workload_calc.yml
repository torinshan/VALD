name: Workload ingest (every 15 min)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  ingest:
    runs-on: ubuntu-latest

    env:
      # ---- GCP / BigQuery ----
      GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
      BQ_DATASET:  ${{ secrets.BQ_DATASET }}   # you stored BQ_* as secrets; that's fine
      BQ_LOCATION: ${{ secrets.BQ_LOCATION }}
      BQ_TABLE:    ${{ secrets.BQ_TABLE }}
      BQ_WRITE_MODE: ${{ secrets.BQ_WRITE_MODE }}

      # ---- OneDrive public link (no auth) ----
      ONEDRIVE_PUBLIC_URL: ${{ vars.ONEDRIVE_PUBLIC_URL }}  # the repo variable you added

      # Optional: debug local file instead of URL
      # LOCAL_FILE_PATH: path/to/Clean_Activities_GPS.csv

    steps:
      - uses: actions/checkout@v4

      # === SAME GOOGLE AUTH METHOD YOU ALREADY USE ===
      - name: Auth to Google Cloud (service account JSON)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}  # must exist and be the full SA JSON
          create_credentials_file: true
          export_environment_variables: true

      - name: Setup gcloud (so R can run `gcloud auth print-access-token`)
        uses: google-github-actions/setup-gcloud@v2

      # R + cached dependencies (pak-backed)
      - name: Setup R
        uses: r-lib/actions/setup-r@v2

      - name: Install R deps (cached)
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          use-public-rspm: true
          cache-version: 1
          extra-packages: |
            any::bigrquery
            any::DBI
            any::dplyr
            any::tidyr
            any::readr
            any::stringr
            any::purrr
            any::tibble
            any::data.table
            any::hms
            any::lubridate
            any::httr
            any::jsonlite
            any::curl
            any::gargle
            any::glue
            any::slider
            any::janitor

      - name: System libs
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev

      - name: Run workload ingest
        run: Rscript workload_ingest.R
