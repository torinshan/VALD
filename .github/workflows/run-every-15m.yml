name: R â†’ BigQuery every 15m (WIF)


on:
schedule:
- cron: "*/15 * * * *" # UTC
workflow_dispatch:


jobs:
run:
runs-on: ubuntu-latest
permissions:
id-token: write
contents: read


steps:
- uses: actions/checkout@v4


- id: auth
uses: google-github-actions/auth@v2
with:
workload_identity_provider: projects/884700516106/locations/global/workloadIdentityPools/gha-pool/providers/github
service_account: gha-bq@sac-vald-hub.iam.gserviceaccount.com


- uses: r-lib/actions/setup-r@v2


# Install required system libraries to avoid build failures
- name: System libs
run: sudo apt-get update && sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev libharfbuzz-dev libfribidi-dev libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev


- name: Install R packages
run: |
R -q -e "install.packages(c('DBI','bigrquery','googledrive','googlesheets4','httr','ragg','rvest','tidyverse','valdr','data.table','hms','lubridate'), repos='https://cloud.r-project.org')"


- name: Run script
env:
GCP_PROJECT: sac-vald-hub
BQ_DATASET: analytics
VALD_CLIENT_ID: ${{ secrets.VALD_CLIENT_ID }}
VALD_CLIENT_SECRET: ${{ secrets.VALD_CLIENT_SECRET }}
VALD_TENANT_ID: ${{ secrets.VALD_TENANT_ID }}
VALD_REGION: use
run: Rscript scripts/run.R
