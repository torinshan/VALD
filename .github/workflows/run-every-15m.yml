name: R â†’ BigQuery every 15m (WIF)

on:
  # TEMPORARILY DISABLED: Experiencing VALD API timeouts (2026-01-05)
  # schedule:
  #   - cron: "*/15 * * * *" # UTC; gate by Pacific hours below
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    concurrency:
      group: vald-q15
      cancel-in-progress: false
    permissions:
      id-token: write
      contents: read
    env:
      GCP_PROJECT: sac-vald-hub
      BQ_DATASET: analytics
      BIGRQUERY_USE_BQ_STORAGE: 'false'
      KEYRING_BACKEND: env
    steps:
    - name: Show current time (UTC/PT)
      run: 'echo "UTC now: $(date -u)"

        echo "LA  now: $(TZ=America/Los_Angeles date)"

        '
    #- name: "Gate to 06:00â€“19:59 PT"
      #id: gate
      #shell: bash
      #run: "LA_HOUR=$(TZ=America/Los_Angeles date +%H)\nif [ \"$LA_HOUR\" -ge 6 ]\
        #\ && [ \"$LA_HOUR\" -lt 20 ]; then\n  echo \"ok=true\" >> \"$GITHUB_OUTPUT\"\
        #\n  echo \"Proceeding (within 06:00â€“19:59 PT).\"\nelse\n  echo \"ok=false\"\
        #\ >> \"$GITHUB_OUTPUT\"\n  echo \"Outside 06:00â€“19:59 PT â€” skipping.\"\
        #\nfi\n"
    # - name: Stop if gate says skip
      # if: steps.gate.outputs.ok != 'true'
      # run: exit 0
    - uses: actions/checkout@v4
    - name: Authenticate to Google Cloud (WIF)
      id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: projects/884700516106/locations/global/workloadIdentityPools/gha-pool/providers/github
        service_account: gha-bq@sac-vald-hub.iam.gserviceaccount.com
        create_credentials_file: true
        token_format: access_token
        access_token_lifetime: 3600s
    - name: Setup gcloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: sac-vald-hub
        install_components: bq
    - name: Test GCP Authentication
      run: 'gcloud auth list

        bq ls --project_id="${GCP_PROJECT}" || echo "BigQuery test failed"

        '
    - uses: r-lib/actions/setup-r@v2
      with:
        use-public-rspm: true
    - name: Install R dependencies (pak)
      uses: r-lib/actions/setup-r-dependencies@v2
      with:
        # Only runtime dependencies needed for production
        extra-packages: |
          any::bigrquery
          any::dplyr
          any::tidyr
          any::readr
          any::stringr
          any::data.table
          any::lubridate
          any::httr2
          any::jsonlite
          any::valdr
          any::logger
          any::readxl
          any::furrr
        # Prevent dev dependencies from being installed
        dependencies: '"hard"'
        cache: true
    - name: System libs
      run: "sudo apt-get update\nsudo apt-get install -y \\\n  libcurl4-openssl-dev\
        \ libssl-dev libxml2-dev \\\n  libfontconfig1-dev libfreetype6-dev libpng-dev\
        \ \\\n  libtiff5-dev libjpeg-dev zlib1g-dev \\\n  libharfbuzz-dev libfribidi-dev\
        \ \\\n  libsecret-1-dev libsecret-1-0\n"
    - name: Verify script exists
      run: test -f .github/scripts/VALD_V2.4.3Cloud.R
    - name: Run R pipeline
      env:
        VALD_CLIENT_ID: ${{ secrets.VALD_CLIENT_ID }}
        VALD_CLIENT_SECRET: ${{ secrets.VALD_CLIENT_SECRET }}
        VALD_TENANT_ID: ${{ secrets.VALD_TENANT_ID }}
        VALD_REGION: use
        KEYRING_BACKEND: env
      run: 'set -e

        Rscript .github/scripts/VALD_V2.4.3Cloud.R

        '
    - name: Ensure BigQuery dataset exists
      if: always()
      run: |
        # Check if dataset exists, create only if it doesn't
        if bq ls --project_id="${GCP_PROJECT}" --dataset_id="${BQ_DATASET}" > /dev/null 2>&1; then
          echo "âœ… Dataset '${BQ_DATASET}' already exists"
        else
          echo "ðŸ“¦ Dataset '${BQ_DATASET}' does not exist, creating..."
          if bq mk --dataset --location=US --default_table_expiration 0 "${GCP_PROJECT}:${BQ_DATASET}"; then
            echo "âœ… Dataset created successfully"
          else
            echo "âš ï¸  Dataset creation failed (non-fatal)"
          fi
        fi
    - name: Check processing logs (tail)
      id: tail_logs
      if: always()
      run: "{\n  bq query --use_legacy_sql=false --location=US --format=pretty \\\n\
        \    \"SELECT FORMAT_TIMESTAMP('%Y-%m-%d %H:%M:%S %Z', timestamp) AS ts, level,\
        \ message\n     FROM \\`${GCP_PROJECT}.${BQ_DATASET}.vald_processing_log\\\
        `\n     WHERE run_id = '${{ github.run_id }}'\n     ORDER BY timestamp DESC\n\
        \     LIMIT 30\";\n} 2>&1 | tee /tmp/log_tail.txt || echo \"No BigQuery logs\
        \ found for this run.\"\necho 'last<<EOF' >> \"$GITHUB_OUTPUT\"\ncat /tmp/log_tail.txt\
        \ >> \"$GITHUB_OUTPUT\"\necho 'EOF' >> \"$GITHUB_OUTPUT\"\n"
    # Email notifications removed: No SMTP credentials configured in repository secrets
    # To enable email notifications, add these secrets and uncomment below:
    #   - SMTP_USERNAME: Gmail address
    #   - SMTP_PASSWORD: Gmail App Password  
    #   - ALERT_EMAIL_TO: Recipient email addresses (comma-separated)
    # Note: For non-Gmail SMTP, you may also need to add SMTP_HOST and SMTP_PORT secrets
    # - name: Send failure notification
    #   if: failure()
    #   uses: dawidd6/action-send-mail@v3
    #   with:
    #     server_address: smtp.gmail.com
    #     server_port: 587
    #     username: ${{ secrets.SMTP_USERNAME }}
    #     password: ${{ secrets.SMTP_PASSWORD }}
    #     subject: "VALD q15 FAILED â€“ run #${{ github.run_number }} on ${{ github.ref_name }}"
    #     to: ${{ secrets.ALERT_EMAIL_TO }}
    #     from: "VALD Bot <vald-bot@example.com>"
    #     html_body: |
    #       <p><strong>Status:</strong> Failed</p>
    #       <p><strong>Repo:</strong> ${{ github.repository }}<br/>
    #       <strong>Run:</strong> <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">Open in GitHub</a><br/>
    #       <strong>Commit:</strong> ${{ github.sha }}<br/>
    #       <strong>Actor:</strong> ${{ github.actor }}</p>
    #       <p><strong>Processing log (last 30 rows):</strong></p>
    #       <pre>${{ steps.tail_logs.outputs.last }}</pre>
