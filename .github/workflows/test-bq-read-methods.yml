name: Test BQ Read

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/884700516106/locations/global/workloadIdentityPools/gha-pool/providers/github
          service_account: gha-bq@sac-vald-hub.iam.gserviceaccount.com
          create_credentials_file: true
          token_format: 'access_token'
      
      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true
      
      - name: Install packages
        run: R -q -e "install.packages(c('bigrquery','httr','gargle','dplyr'))"
      
      - name: Test REST API
        run: |
          Rscript -e '
          library(bigrquery); library(httr); library(gargle); library(dplyr)
          
          token <- system("gcloud auth print-access-token", intern=TRUE)[1]
          t <- gargle::gargle2.0_token(scope="https://www.googleapis.com/auth/bigquery",
                                        client=gargle::gargle_client(),
                                        credentials=list(access_token=token))
          bq_auth(token=t)
          
          url <- "https://bigquery.googleapis.com/bigquery/v2/projects/sac-vald-hub/datasets/analytics/tables/dates/data?maxResults=3"
          resp <- GET(url, add_headers(Authorization=paste("Bearer", bq_token()$credentials$access_token)))
          
          if(http_error(resp)) stop("Failed: ", content(resp,"text"))
          
          cat("SUCCESS: REST API works\n")
          print(content(resp,"parsed")$totalRows)
          '
